<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="twitter:card" content="summary_large_image" /><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Modern Python part 3 - run a CI pipeline &amp; publish your package to PiPy | Braza Faouzi</title>
<meta name="generator" content="Jekyll v4.1.1" />
<meta property="og:title" content="Modern Python part 3 - run a CI pipeline &amp; publish your package to PiPy" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Automate the tests and CI chain to fasten publication of your Python package" />
<meta property="og:description" content="Automate the tests and CI chain to fasten publication of your Python package" />
<link rel="canonical" href="https://fbraza.github.io/BrazLog/python/devops/2021/06/29/modern-python-part3.html" />
<meta property="og:url" content="https://fbraza.github.io/BrazLog/python/devops/2021/06/29/modern-python-part3.html" />
<meta property="og:site_name" content="Braza Faouzi" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-06-29T00:00:00-05:00" />
<script type="application/ld+json">
{"url":"https://fbraza.github.io/BrazLog/python/devops/2021/06/29/modern-python-part3.html","@type":"BlogPosting","headline":"Modern Python part 3 - run a CI pipeline &amp; publish your package to PiPy","dateModified":"2021-06-29T00:00:00-05:00","datePublished":"2021-06-29T00:00:00-05:00","mainEntityOfPage":{"@type":"WebPage","@id":"https://fbraza.github.io/BrazLog/python/devops/2021/06/29/modern-python-part3.html"},"description":"Automate the tests and CI chain to fasten publication of your Python package","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/BrazLog/assets/css/style.css"><link type="application/atom+xml" rel="alternate" href="https://fbraza.github.io/BrazLog/feed.xml" title="Braza Faouzi" /><link rel="shortcut icon" type="image/x-icon" href="/BrazLog/images/favicon.ico"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Primer/15.2.0/primer.css" integrity="sha512-xTz2ys4coGAOz8vuV1NcQBkgVmKhsSEtjbqyMJbBHRplFuvKIUo6xhLHpAyPt9mfR6twHJgn9OgVLuqOvjeBhg==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha512-1PKOgIY59xJ8Co8+NE6FZ+LOAZKjy+KY8iq0G4B3CyeY6wYHN3yt9PW0XpSriVlkMXe40PTKnXrLnZ9+fkDaog==" crossorigin="anonymous" />

<script>
function wrap_img(fn) {
    if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
        var elements = document.querySelectorAll(".post img");
        Array.prototype.forEach.call(elements, function(el, i) {
            if (el.getAttribute("title") && (el.className != "emoji")) {
                const caption = document.createElement('figcaption');
                var node = document.createTextNode(el.getAttribute("title"));
                caption.appendChild(node);
                const wrapper = document.createElement('figure');
                wrapper.className = 'image';
                el.parentNode.insertBefore(wrapper, el);
                el.parentNode.removeChild(el);
                wrapper.appendChild(el);
                wrapper.appendChild(caption);
            }
        });
    } else { document.addEventListener('DOMContentLoaded', fn); }
}
window.onload = wrap_img;
</script>

<script>
    document.addEventListener("DOMContentLoaded", function(){
    // add link icon to anchor tags
    var elem = document.querySelectorAll(".anchor-link")
    elem.forEach(e => (e.innerHTML = '<i class="fas fa-link fa-xs"></i>'));
    });
</script>
</head>
<body><header class="site-header">

  <div class="wrapper"><a class="site-title" rel="author" href="/BrazLog/">Braza Faouzi</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/BrazLog/about/">About Me</a><a class="page-link" href="/BrazLog/search/">Search</a><a class="page-link" href="/BrazLog/categories/">Tags</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Modern Python part 3 - run a CI pipeline &amp; publish your package to PiPy</h1><p class="page-description">Automate the tests and CI chain to fasten publication of your Python package</p><p class="post-meta post-meta-title"><time class="dt-published" datetime="2021-06-29T00:00:00-05:00" itemprop="datePublished">
        Jun 29, 2021
      </time>
       ‚Ä¢ <span class="read-time" title="Estimated read time">
    
    
      10 min read
    
</span></p>

    
      <p class="category-tags"><i class="fas fa-tags category-tags-icon"></i></i> 
      
        <a class="category-tags-link" href="/BrazLog/categories/#Python">Python</a>
        &nbsp;
      
        <a class="category-tags-link" href="/BrazLog/categories/#DevOps">DevOps</a>
        
      
      </p>
    

    </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>To propose a well-maintained and usable Python package to the open-source community or even inside your company, you are expected to accomplish a set of critical steps. First ensure that your code is unit tested. Second respect the common writing and format styles. Automate these steps and integrate them in a continuous integration pipeline to avoid any regression that stems from modifications applied to your source code. Finally, provide enough documentation for future users. Once done it is common to publish your Python package on the <a href="https://pypi.org/">Python Package Index (PyPI)</a>. Here we are going to see how to accomplish each of these steps using <a href="https://python-poetry.org/">Poetry</a>, <a href="https://tox.readthedocs.io/en/latest/">Tox</a> and <a href="https://github.com/features/actions">GitHub Actions</a>. The code used for our use case can be found <a href="https://github.com/adaltas/summarize_dataframe">on our repository</a>.</p>

<p>This article is the last one from a series of three in which I share some best practices.</p>

<ul>
  <li>Part 1: <a href="https://fbraza.github.io/BrazLog/python/devops/2021/06/09/modern-python-part1.html">project initialization with pyenv and poetry</a></li>
  <li>Part 2: <a href="https://fbraza.github.io/BrazLog/python/devops/2021/06/24/modern-python-part2.html">unit testing and commit enforcement</a></li>
  <li>Part 3: <a href="https://fbraza.github.io/BrazLog/python/devops/2021/06/29/modern-python-part3.html">CI pipeline with GitHub Actions and publication on PiPy</a></li>
</ul>

<h2 id="automate-linter-checks-and-tests-with-tox">Automate linter checks and tests with <code class="language-plaintext highlighter-rouge">tox</code></h2>

<p>If not done, activate your virtual environment.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry shell
</code></pre></div></div>

<p>To check the conformity of our code, we use a couple of packages that are going to evaluate if the code respects the common Python writing guidelines. Then, to automate their execution as well as our unit tests, we use <a href="https://tox.readthedocs.io/en/latest/">tox</a>. To install them run:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add black flake8 pylint tox <span class="nt">--dev</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">tox</code> and <code class="language-plaintext highlighter-rouge">poetry</code> don‚Äôt work well together by default. They are somewhat redundant. To use them together, we need to implement a few tricks (see issues <a href="https://github.com/python-poetry/poetry/issues/1941">1941</a> and <a href="https://github.com/python-poetry/poetry/issues/1745">1745</a>). <code class="language-plaintext highlighter-rouge">tox</code> install its own environment and dependencies to run its tasks. But to install dependencies, you have to declare the command <code class="language-plaintext highlighter-rouge">poetry install</code> in our <code class="language-plaintext highlighter-rouge">tox</code> configuration. This brings redundancy and can lead to some <a href="https://github.com/python-poetry/poetry/issues/1745">issues</a>. Moreover, this does not allow to install developers dependencies needed to execute our tests. It is more productive to let <code class="language-plaintext highlighter-rouge">tox</code> use the <code class="language-plaintext highlighter-rouge">poetry.lock</code> file to install necessary dependencies. For this, I advise you to use the <a href="https://github.com/enpaul/tox-poetry-installer">tox-poetry-installer</a> package developed to solve these problems:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add tox-poetry-installer[poetry] <span class="nt">--dev</span>
</code></pre></div></div>

<p>Now we declare our <code class="language-plaintext highlighter-rouge">tox</code> configuration in a <code class="language-plaintext highlighter-rouge">tox.ini</code> file whose content is:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[tox]</span>
<span class="py">envlist</span> <span class="p">=</span> <span class="s">py38</span>
<span class="py">isolated_build</span> <span class="p">=</span> <span class="s">true</span>

<span class="nn">[testenv]</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">Linting, checking syntax and running tests</span>
<span class="py">require_locked_deps</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">install_dev_deps</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">commands</span> <span class="p">=</span>
    <span class="err">poetry</span> <span class="err">run</span> <span class="err">black</span> <span class="err">summarize_dataframe/summarize_df.py</span>
    <span class="err">poetry</span> <span class="err">run</span> <span class="err">flake8</span> <span class="err">summarize_dataframe/summarize_df.py</span>
    <span class="err">poetry</span> <span class="err">run</span> <span class="err">pylint</span> <span class="err">summarize_dataframe/summarize_df.py</span>
    <span class="err">poetry</span> <span class="err">run</span> <span class="err">pytest</span> <span class="err">-v</span>
</code></pre></div></div>

<p>You can see two sections here:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">[tox]</code></strong>: Define the global settings for your <code class="language-plaintext highlighter-rouge">tox</code> automation pipeline including the Python version of the test environments.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">[testenv]</code></strong>: Define the test environments. In our case we have some extra-variables <code class="language-plaintext highlighter-rouge">require_locked_deps</code> and <code class="language-plaintext highlighter-rouge">install_dev_deps</code> that are brought by the <a href="https://github.com/enpaul/tox-poetry-installer">tox-poetry-installer</a> package. <code class="language-plaintext highlighter-rouge">require_locked_deps</code> is to choose whether or not you want <code class="language-plaintext highlighter-rouge">tox</code> to harness the <code class="language-plaintext highlighter-rouge">poetry.lock</code> file to install dependencies. <code class="language-plaintext highlighter-rouge">install_dev_deps</code> is to choose if <code class="language-plaintext highlighter-rouge">tox</code> installs the developer dependencies.</li>
</ul>

<blockquote>
  <p>Refer to the <a href="https://tox.readthedocs.io/en/latest/config.html#tox-global-settings"><code class="language-plaintext highlighter-rouge">tox</code> documentation</a> to learn more about the configuration as well as the <a href="https://github.com/enpaul/tox-poetry-installer"><code class="language-plaintext highlighter-rouge">tox-poetry-installer</code> documentation</a> to learn more about it extra configuration.</p>
</blockquote>

<p>Run the <code class="language-plaintext highlighter-rouge">tox</code> pipeline:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tox
py38 run-test: commands[0] | poetry run black summarize_dataframe/summarize_df.py
All <span class="k">done</span><span class="o">!</span> ‚ú® üç∞ ‚ú®
1 file left unchanged.
py38 run-test: commands[1] | poetry run flake8 summarize_dataframe/summarize_df.py
py38 run-test: commands[2] | poetry run pylint summarize_dataframe/summarize_df.py
<span class="k">*************</span> Module summarize_dataframe.summarize_df
summarize_dataframe/summarize_df.py:1:0: C0114: Missing module docstring <span class="o">(</span>missing-module-docstring<span class="o">)</span>
summarize_dataframe/summarize_df.py:4:0: C0103: Argument name <span class="s2">"df"</span> doesn<span class="s1">'t conform to snake_case naming style (invalid-name)
summarize_dataframe/summarize_df.py:11:4: C0103: Argument name "df" doesn'</span>t conform to snake_case naming style <span class="o">(</span>invalid-name<span class="o">)</span>
summarize_dataframe/summarize_df.py:23:4: C0103: Argument name <span class="s2">"df"</span> doesn<span class="s1">'t conform to snake_case naming style (invalid-name)
summarize_dataframe/summarize_df.py:43:0: C0103: Argument name "df" doesn'</span>t conform to snake_case naming style <span class="o">(</span>invalid-name<span class="o">)</span>

<span class="nt">------------------------------------------------------------------</span>
Your code has been rated at 7.62/10 <span class="o">(</span>previous run: 7.62/10, +0.00<span class="o">)</span>

ERROR: InvocationError <span class="k">for </span><span class="nb">command</span> /home/fbraza/Documents/python_project/summarize_dataframe/.tox/py38/bin/poetry run pylint summarize_dataframe/summarize_df.py <span class="o">(</span>exited with code 16<span class="o">)</span>
________________________________________________________ summary ________________________________________________________________
ERROR:   py38: commands failed
</code></pre></div></div>

<p>An error is raised because <a href="https://www.pylint.org/">pylint</a> shed light on some style inconsistencies. By default, <code class="language-plaintext highlighter-rouge">tox</code> quits if any warnings or errors occurred during the execution of the commands. The errors are by themselves quite explicit. After correcting them, run again the pipeline:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tox
<span class="c"># shorten for brevety [...]</span>
py38 run-test: commands[0] | poetry run black summarize_dataframe/summarize_df.py
All <span class="k">done</span><span class="o">!</span> ‚ú® üç∞ ‚ú®
1 file left unchanged.
py38 run-test: commands[1] | poetry run flake8 summarize_dataframe/summarize_df.py
py38 run-test: commands[2] | poetry run pylint summarize_dataframe/summarize_df.py

<span class="nt">--------------------------------------------------------------------</span>
Your code has been rated at 10.00/10 <span class="o">(</span>previous run: 10.00/10, +0.00<span class="o">)</span>

py38 run-test: commands[3] | poetry run pytest <span class="nt">-v</span>
<span class="o">=================================================</span> <span class="nb">test </span>session starts <span class="o">=============================================================</span>
platform linux <span class="nt">--</span> Python 3.8.7, pytest-5.4.3, py-1.10.0, pluggy-0.13.1 <span class="nt">--</span> /home/fbraza/Documents/python_project/summarize_dataframe/.tox/py38/bin/python
cachedir: .tox/py38/.pytest_cache
rootdir: /home/fbraza/Documents/python_project/summarize_dataframe
collected 2 items

tests/test_summarize_dataframe.py::TestDataSummary::test_data_summary PASSED                                                                                           <span class="o">[</span> 50%]
tests/test_summarize_dataframe.py::TestDataSummary::test_display PASSED                                                                                                <span class="o">[</span>100%]

<span class="o">=================================================</span> 2 passed <span class="k">in </span>0.30s <span class="o">===============================================================</span>
______________________________________________________ summary ____________________________________________________________________
  py38: commands succeeded
  congratulations :<span class="o">)</span>
</code></pre></div></div>

<p>Perfect. The <code class="language-plaintext highlighter-rouge">tox</code> automation pipeline succeed locally. The next step start implements the CI pipeline with GitHub Actions.</p>

<h2 id="continuous-integration-with-github-actions">Continuous Integration with GitHub Actions</h2>

<p>GitHub Actions make it easy to automate all your software workflows. This service is event-driven meaning that a set of commands is triggered when a specific event occurs. Such events could be a commit pushed to the branch or a pull request. GitHub Actions are pretty convenient to run all needed tests against your code.</p>

<p>Most importantly, GitHub Actions provide the ability to test your Python package using several Python versions and on different operating systems (Linux, macOS and Windows). The only thing you need is an existing repository and a <code class="language-plaintext highlighter-rouge">.github/workflows/&lt;file_name&gt;.yaml</code> file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">mkdir</span> <span class="nt">-p</span> .github/workflows
<span class="nb">touch</span> .github/workflows/ci.yml
</code></pre></div></div>

<p>The content of the <code class="language-plaintext highlighter-rouge">.github/workflows/ci.yml</code> file is:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">name</span><span class="pi">:</span> <span class="s">CI Pipeline for summarize_df</span>

<span class="na">on</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="s">push</span>
  <span class="pi">-</span> <span class="s">pull_request</span>

<span class="na">jobs</span><span class="pi">:</span>
  <span class="na">build</span><span class="pi">:</span>
    <span class="na">runs-on</span><span class="pi">:</span> <span class="s">$</span>
    <span class="na">strategy</span><span class="pi">:</span>
      <span class="na">matrix</span><span class="pi">:</span>
        <span class="na">platform</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">ubuntu-latest</span><span class="pi">,</span> <span class="nv">macos-latest</span><span class="pi">,</span> <span class="nv">windows-latest</span><span class="pi">]</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="pi">[</span><span class="nv">3.7</span><span class="pi">,</span> <span class="nv">3.8</span><span class="pi">,</span> <span class="nv">3.9</span><span class="pi">]</span>

    <span class="na">steps</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/checkout@v1</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set up Python $</span>
      <span class="na">uses</span><span class="pi">:</span> <span class="s">actions/setup-python@v2</span>
      <span class="na">with</span><span class="pi">:</span>
        <span class="na">python-version</span><span class="pi">:</span> <span class="s">$</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Install dependencies</span>
      <span class="na">run</span><span class="pi">:</span> <span class="pi">|</span>
        <span class="s">python -m pip install poetry</span>
        <span class="s">poetry install</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Test with tox</span>
      <span class="na">run</span><span class="pi">:</span> <span class="s">poetry run tox</span>
</code></pre></div></div>

<p>A few words about the different fields:</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">on</code></strong>: this field defines the type of event that is going to trigger the pipeline.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">jobs</code></strong>: this field defines the multiple steps of your pipeline. They run in an instance of a virtual environment.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">build</code></strong>: this is where all the magic happens:
    <ul>
      <li>The <code class="language-plaintext highlighter-rouge">strategy.matrix.platform</code> field defines the different OS you want to use to test your package. Use templating to pass these values to the <code class="language-plaintext highlighter-rouge">build.runs-on</code> field (<code class="language-plaintext highlighter-rouge">$</code>) .</li>
      <li>The <code class="language-plaintext highlighter-rouge">strategy.matrix.python-version</code> field defines the different versions of Python you want to use to test your package.</li>
      <li>The <code class="language-plaintext highlighter-rouge">steps</code> field permits you to specify which actions you use (<code class="language-plaintext highlighter-rouge">steps.uses</code>) and which command you want to run (<code class="language-plaintext highlighter-rouge">steps.run</code>)</li>
    </ul>
  </li>
</ul>

<p>Before finishing, alter the <code class="language-plaintext highlighter-rouge">tox.ini</code> and <code class="language-plaintext highlighter-rouge">pyporject.toml</code> files accordingly. Initially we chose the <code class="language-plaintext highlighter-rouge">3.8</code> Python version for <code class="language-plaintext highlighter-rouge">tox</code>. But we want it to be compatible with  <code class="language-plaintext highlighter-rouge">3.7</code> and <code class="language-plaintext highlighter-rouge">3.9</code>. For the <code class="language-plaintext highlighter-rouge">pyproject.toml</code> file, choose a version expected to be compatible with your package. Here we choose to make our package compatible from <code class="language-plaintext highlighter-rouge">3.7.1</code> and above. Below are the changes added to our files:</p>

<div class="language-ini highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># content of: tox.ini
</span><span class="nn">[tox]</span>
<span class="py">envlist</span> <span class="p">=</span> <span class="s">py37,py38,py39</span>
<span class="py">isolated_build</span> <span class="p">=</span> <span class="s">true</span>
<span class="py">skip_missing_interpreters</span> <span class="p">=</span> <span class="s">true</span>

<span class="nn">[...]</span>
</code></pre></div></div>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># content of: pyproject.toml</span>
<span class="nn">[...]</span>

<span class="nn">[tool.poetry.dependencies]</span>
<span class="py">python</span> <span class="p">=</span> <span class="s">"^3.7.1"</span>

<span class="nn">[...]</span>
</code></pre></div></div>

<blockquote>
  <p>When you modify the <code class="language-plaintext highlighter-rouge">pyproject.toml</code> file, <strong>always</strong> run the <code class="language-plaintext highlighter-rouge">poetry update</code> command that can check some unexpected incompatibilities between your dependencies and the version of Python you wish to use.</p>
</blockquote>

<p>To finish, we are going to install a package, called <a href="https://github.com/ymyzk/tox-gh-actions">tox-gh-actions</a>, to run <code class="language-plaintext highlighter-rouge">tox</code> in parallel on GitHub while using several versions of Python:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry add tox-gh-actions <span class="nt">--dev</span>
</code></pre></div></div>

<p>The pipeline is ready. Add, commit and push your changes to see the pipeline running:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"!.github/"</span> <span class="o">&gt;&gt;</span> .gitignore
git add .gitignore
git commit <span class="nt">-m</span> <span class="s2">"build: update .gitignore to unmask .github/ folder"</span>
git add pyproject.toml tox.ini poetry.lock <span class="sb">`</span>.github/workflows/ci.yml<span class="sb">`</span>
git commit <span class="nt">-m</span> <span class="s2">"build: tox pipeline + github actions CI pipeline"</span>
</code></pre></div></div>

<p>Go to your GitHub repository and click on the <strong>Actions</strong> tab:</p>

<p><img src="/BrazLog/images/gh01.png" alt="GitHub action" /></p>

<p>You see all the previous and ongoing pipelines:</p>

<p><img src="/BrazLog/images/gh02.png" alt="Workflow runs" /></p>

<p>Let‚Äôs click on the ongoing pipeline. The pipeline runs on each OS and for each Python version. Wait a couple of minutes to see the results:</p>

<p><img src="/BrazLog/images/gh03.png" alt="Job completed" /></p>

<p>All the pipelines succeed! We are ready to publish our package on the PyPi registry.</p>

<h2 id="publish-packages-on-pypi-with-poetry">Publish packages on PyPi with <code class="language-plaintext highlighter-rouge">poetry</code></h2>

<p>To make your package publishable, add some details in the <code class="language-plaintext highlighter-rouge">[tool.poetry]</code> section of your <code class="language-plaintext highlighter-rouge">pyproject.toml</code> file:</p>

<div class="language-toml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">[tool.poetry]</span>
<span class="py">name</span> <span class="p">=</span> <span class="s">"summarize_dataframe"</span>
<span class="py">version</span> <span class="p">=</span> <span class="s">"0.1.0"</span>
<span class="py">description</span> <span class="p">=</span> <span class="s">"A package to provide summary data about pandas DataFrame"</span>
<span class="py">license</span> <span class="p">=</span> <span class="s">"MIT"</span>
<span class="py">authors</span> <span class="p">=</span> <span class="p">[</span><span class="s">"fbraza &lt;fbraza@tutanota.com&gt;"</span><span class="p">]</span>
<span class="py">keywords</span> <span class="p">=</span> <span class="p">[</span><span class="s">"pandas"</span><span class="p">,</span> <span class="s">"dataframe"</span><span class="p">]</span>
<span class="py">readme</span> <span class="p">=</span> <span class="s">"README.md"</span>
<span class="py">homepage</span> <span class="p">=</span> <span class="s">"https://github.com/fbraza/summarize_dataframe"</span>
<span class="py">repository</span> <span class="p">=</span> <span class="s">"https://github.com/fbraza/summarize_dataframe"</span>
<span class="py">include</span> <span class="p">=</span> <span class="nn">["CHANGELOG.md"]</span>

<span class="nn">[...]</span>
</code></pre></div></div>

<p>All the variables here are quite explicit. These are metadata needed for the publication of the package. The <code class="language-plaintext highlighter-rouge">include</code> variable is interesting to add any files you want. In our case we are going to add a <code class="language-plaintext highlighter-rouge">CHANGELOG.md</code> file. Do you remember <code class="language-plaintext highlighter-rouge">commitizen</code>? If not please take the time to read our article on <a href="/en/2021/06/24/unit-tests-conventional-commits/">commitizen and conventional commits</a>. Use the following command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cz bump
</code></pre></div></div>

<p>It prints the semantic version from your <code class="language-plaintext highlighter-rouge">pyproject.toml</code> file and ask you to create a Git tag. The version will be updated based on your Git commit. Next we create the <code class="language-plaintext highlighter-rouge">CHANGELOG.md</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>cz changelog
<span class="nb">cat </span>CHANGELOG.md

<span class="c">## Unreleased</span>

<span class="c">## 0.1.0 (2021-04-28)</span>

<span class="c">### Refactor</span>

- correct pylint warnings
- <span class="nb">split </span>the <span class="k">function </span>into two: one returning <span class="nb">df </span>other <span class="k">for </span>output

<span class="c">### Feat</span>

- implementation of the summary <span class="k">function </span>to summarize dataframe
</code></pre></div></div>

<p>Your <code class="language-plaintext highlighter-rouge">CHANGELOG.md</code> has been created based on the Git history you generated thanks to <code class="language-plaintext highlighter-rouge">commitizen</code>. Pretty neat isn‚Äôt it?! Once done let‚Äôs focus on publishing our package:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry build
Building summarize_dataframe <span class="o">(</span>0.1.0<span class="o">)</span>
  - Building sdist
  - Built summarize_dataframe-0.1.0.tar.gz
  - Building wheel
  - Built summarize_dataframe-0.1.0-py3-none-any.whl
</code></pre></div></div>

<p>This creates a folder called <code class="language-plaintext highlighter-rouge">dist</code> where the built package is located. To test if everything works you can use <code class="language-plaintext highlighter-rouge">pip</code>:</p>

<blockquote>
  <p>Do this outside of your virtual environment to not pollute it.</p>
</blockquote>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pip <span class="nb">install </span>path/to/your/package/summarize_dataframe-0.1.0-py3-none-any.whl
</code></pre></div></div>

<p>Now we need to create an account on <a href="https://pypi.org/account/register/">PyPi</a>. Just enter the expected details, validate your email and execute:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry publish
Username: <span class="k">***********</span>
Password: <span class="k">***********</span>
Publishing summarize_dataframe <span class="o">(</span>0.1.0<span class="o">)</span> to PyPI
 - Uploading summarize_dataframe-0.1.0-py3-none-any.whl 100%
 - Uploading summarize_dataframe-0.1.0.tar.gz 100%
</code></pre></div></div>

<p>The package is now online and shared with the community.</p>

<p><img src="/BrazLog/images/gh04.png" alt="Project publication on PyPi" /></p>

<h2 id="conclusion">Conclusion</h2>

<p><code class="language-plaintext highlighter-rouge">tox</code> provides a nice interface to automate all your unit tests and validation checks. The ecosystem around <code class="language-plaintext highlighter-rouge">poetry</code> is getting more mature and provides solutions to work with <code class="language-plaintext highlighter-rouge">tox</code> without too much hassle. Collectively, these two solutions permit to establish a very efficient and coherent CI pipeline. To run the pipeline and test your packages against different OS or versions of Python, you can leverage GitHub Actions as described above.</p>

<p><code class="language-plaintext highlighter-rouge">poetry</code> was at the center of our approach. From the project initialization to its publication and going through the management of its packages and dependencies. <code class="language-plaintext highlighter-rouge">poetry</code> demonstrated its ease of use and efficacy that will definitely facilitate the life of developers, Data Scientists or Data Engineers who develop projects in Python.</p>

<p>Our articles describe a full setup that you can leverage to build your own Python project to respect good software engineering practices.</p>

<h2 id="cheat-sheet">Cheat Sheet</h2>

<h3 id="tox"><code class="language-plaintext highlighter-rouge">tox</code></h3>

<ul>
  <li>
    <p>Run your tox pipeline</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tox
</code></pre></div>    </div>
  </li>
</ul>

<h3 id="poetry"><code class="language-plaintext highlighter-rouge">poetry</code></h3>

<ul>
  <li>
    <p>Build your package</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry build
</code></pre></div>    </div>
  </li>
  <li>
    <p>Publish your package</p>

    <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>poetry publish
</code></pre></div>    </div>
  </li>
</ul>

<h2 id="acknowledgments">Acknowledgments</h2>

<p>This article was first published in Adaltas <a href="https://www.adaltas.com/en/articles/">blog</a> and kindly reviewed by the CEO David Worms and one consultant Barthelemy NGOM.</p>

  </div><!-- from https://github.com/utterance/utterances -->
<script src="https://utteranc.es/client.js"
        repo="fbraza/BrazLog"
        issue-term="title"
        label="blogpost-comment"
        theme="github-light"
        crossorigin="anonymous"
        async>
</script><a class="u-url" href="/BrazLog/python/devops/2021/06/29/modern-python-part3.html" hidden></a>
</article>
      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/BrazLog/"></data>

  <div class="wrapper">

    <div class="footer-col-wrapper">
      <div class="footer-col">
        <p class="feed-subscribe">
          <a href="/BrazLog/feed.xml">
            <svg class="svg-icon orange">
              <use xlink:href="/BrazLog/assets/minima-social-icons.svg#rss"></use>
            </svg><span>Subscribe</span>
          </a>
        </p>
      </div>
      <div class="footer-col">
        <p>Python ¬∑ Scala ¬∑ BigData ¬∑ System Design ¬∑ Data Engineering</p>
      </div>
    </div>

    <div class="social-links"><ul class="social-media-list"><li><a rel="me" href="https://github.com/fbraza" title="fbraza"><svg class="svg-icon grey"><use xlink:href="/BrazLog/assets/minima-social-icons.svg#github"></use></svg></a></li><li><a rel="me" href="https://twitter.com/%40braza_faouzi" title="@braza_faouzi"><svg class="svg-icon grey"><use xlink:href="/BrazLog/assets/minima-social-icons.svg#twitter"></use></svg></a></li></ul>
</div>

  </div>

</footer>
</body>

</html>
